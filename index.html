<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Q&A Practice</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  

  <!-- MathJax for LaTeX rendering -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

  <link rel="stylesheet" href="web_utils/style.css">

</head>

<body>
  <h1>Q&A Practice</h1>
  <br>
  <!-- Row 1: Mode buttons -->
  <div class="mode-switch">
    <button id="all-btn" class="active">üß† All Mode</button>
    <button id="practice-btn">‚ö° Practice Mode</button>
  </div>
  <br>
  <!-- Row 2: Topic Tabs -->
  <div class="topic-tabs" id="topic-tabs"></div>
  <br>
  <div id="qa-container"></div>

  <script>
    let qaData = [];
    let mode = "all";
    let currentTopic = "All";
    let currentIndex = -1;
    let order = [];
    let visited = [];

    // OpenRouter API configuration
    const OPENROUTER_API_KEY = "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"; // User needs to add their API key
    const OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions";
    const OPENROUTER_MODEL = "allenai/molmo-2-8b:free"; // Free model

    async function verifyAnswerWithLLM(userAnswer, correctAnswer, question) {
      if (!OPENROUTER_API_KEY) {
        return {
          success: false,
          error: "OpenRouter API key not configured. Please add your API key in the code."
        };
      }

      const prompt = `You are an expert evaluator. Compare the user's answer with the correct answer for the following question.

Question: ${question}

Correct Answer:
${correctAnswer}

User's Answer:
${userAnswer}

Please provide:
1. A similarity score from 0-100 (where 100 means perfect match)
2. A brief analysis of how well the user's answer matches the correct answer
3. Key points that are correct or missing
4. Overall feedback

Format your response as JSON:
{
  "score": <number 0-100>,
  "analysis": "<brief analysis>",
  "keyPoints": "<key points>",
  "feedback": "<overall feedback>"
}`;

      try {
        const response = await fetch(OPENROUTER_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
            "HTTP-Referer": window.location.origin,
            "X-Title": "Q&A Practice App"
          },
          body: JSON.stringify({
            model: OPENROUTER_MODEL,
            messages: [
              {
                role: "user",
                content: prompt
              }
            ],
            temperature: 0.3
          })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        const llmResponse = data.choices[0].message.content;

        // Try to parse JSON from the response
        try {
          // Extract JSON from markdown code blocks if present
          const jsonMatch = llmResponse.match(/```(?:json)?\s*(\{[\s\S]*\})\s*```/) || 
                          llmResponse.match(/\{[\s\S]*\}/);
          const parsed = JSON.parse(jsonMatch ? jsonMatch[1] : llmResponse);
          return { success: true, ...parsed };
        } catch (parseError) {
          // If JSON parsing fails, return the raw response
          return {
            success: true,
            score: null,
            analysis: llmResponse,
            keyPoints: "",
            feedback: llmResponse
          };
        }
      } catch (error) {
        return {
          success: false,
          error: error.message || "Failed to verify answer"
        };
      }
    }

    function populateTopicTabs() {
      const topics = [...new Set(qaData.map(q => q.type).filter(Boolean))];
      const tabContainer = $("#topic-tabs");
      tabContainer.empty();

      // Always include "All"
      tabContainer.append(`<div class="topic-tab active" data-topic="All">All</div>`);
      topics.forEach(topic => {
        tabContainer.append(`<div class="topic-tab" data-topic="${topic}">${topic}</div>`);
      });

      $(".topic-tab").on("click", function () {
        $(".topic-tab").removeClass("active");
        $(this).addClass("active");
        currentTopic = $(this).data("topic");
        setMode(mode);
      });
    }

    function getFilteredData() {
      return currentTopic === "All" ? qaData : qaData.filter(q => q.type === currentTopic);
    }

    function renderAllMode() {
      const container = $("#qa-container");
      container.empty();
      const filtered = getFilteredData();

      filtered.forEach((q) => {
        const tagsHtml = q.tags && q.tags.length > 0 
          ? `<div class="tags-container">${q.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`
          : '';
        const card = $(`
          <div class="qa-card">
            <div class="type-tags-row">
              <div class="type-label">${q.type}</div>
              ${tagsHtml}
            </div>
            <div class="question">${q.id}. ${q.question}<span class="toggle-icon">+</span></div>
            <div class="answer">${q.answer}</div>
          </div>
        `);
        container.append(card);
      });

      $(".answer").hide();
      $(".toggle-icon").text("+");

      $(".question").on("click", function () {
        const ans = $(this).siblings(".answer");
        const icon = $(this).find(".toggle-icon");
        const isVisible = ans.is(":visible");
        ans.slideToggle(200);
        icon.text(isVisible ? "+" : "‚àí");
      });

      if (window.MathJax) MathJax.typesetPromise();
    }

    function renderPracticeMode(index = null) {
      const container = $("#qa-container");
      container.empty();
      const filteredData = getFilteredData();

      if (filteredData.length === 0) {
        container.html(`<p>‚ö†Ô∏è No questions in this topic.</p>`);
        return;
      }

      if (order.length === 0) {
        order = [...Array(filteredData.length).keys()];
        for (let i = order.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [order[i], order[j]] = [order[j], order[i]];
        }
        visited = [];
      }

      if (index !== null) currentIndex = index;
      else currentIndex = visited.length;

      if (currentIndex >= order.length) {
        container.html(`<p>üéâ You've completed all questions in this topic!</p>`);
        return;
      }

      const qIndex = order[currentIndex];
      visited.push(qIndex);
      const q = filteredData[qIndex];

      const tagsHtml = q.tags && q.tags.length > 0 
        ? `<div class="tags-container">${q.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`
        : '';
      const card = $(`
        <div class="practice-card">
          <div class="counter">Question ${currentIndex + 1} / ${filteredData.length}</div>
          <div class="type-tags-row">
            <div class="type-label">${q.type}</div>
            ${tagsHtml}
          </div>
          <div class="question">${q.id}. ${q.question}</div>
          <textarea class="user-input" id="user-answer" placeholder="Type your answer here..."></textarea>
          <div>
            <button id="verify-btn">ü§ñ Verify with LLM</button>
            <button id="check-btn">Check Answer</button>
            <button id="prev-btn">Previous</button>
            <button id="next-btn">Next</button>
          </div>
          <div id="verification-result" class="verification-box" style="display: none;"></div>
          <div id="correct-answer" class="answer-box">${q.answer}</div>
        </div>
      `);

      container.append(card);

      $("#verify-btn").on("click", async () => {
        const userAnswer = $("#user-answer").val().trim();
        if (!userAnswer) {
          alert("Please enter an answer before verifying.");
          return;
        }

        $("#verify-btn").prop("disabled", true).text("üîÑ Verifying...");
        const resultDiv = $("#verification-result");
        resultDiv.html("<p>üîÑ Verifying your answer with LLM...</p>").slideDown(300);

        const verification = await verifyAnswerWithLLM(userAnswer, q.answer, q.question);

        if (!verification.success) {
          resultDiv.html(`
            <div class="verification-error">
              <p><strong>‚ùå Error:</strong> ${verification.error}</p>
            </div>
          `);
        } else {
          const score = verification.score !== null ? verification.score : "N/A";
          const scoreColor = verification.score >= 80 ? "#4CAF50" : verification.score >= 60 ? "#FF9800" : "#F44336";

          resultDiv.html(`
            <div class="verification-content">
              <div class="score-display" style="background: ${scoreColor}; color: white; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center;">
                <h3>Score: ${score}${verification.score !== null ? '/100' : ''}</h3>
              </div>
              <div class="verification-details">
                <p><strong>Analysis:</strong></p>
                <p>${verification.analysis || verification.feedback}</p>
                ${verification.keyPoints ? `<p><strong>Key Points:</strong></p><p>${verification.keyPoints}</p>` : ''}
                ${verification.feedback && verification.analysis ? `<p><strong>Feedback:</strong></p><p>${verification.feedback}</p>` : ''}
              </div>
            </div>
          `);
        }

        $("#verify-btn").prop("disabled", false).text("ü§ñ Verify with LLM");
        if (window.MathJax) MathJax.typesetPromise();
      });

      $("#check-btn").on("click", () => $("#correct-answer").slideDown(300));
      $("#next-btn").on("click", () => {
        if (currentIndex < order.length - 1) renderPracticeMode(currentIndex + 1);
        else container.html(`<p>üéâ You've completed all questions!</p>`);
      });
      $("#prev-btn").on("click", () => {
        if (currentIndex > 0) renderPracticeMode(currentIndex - 1);
      });

      if (window.MathJax) MathJax.typesetPromise();
    }

    function setMode(newMode) {
      mode = newMode;
      $("#all-btn").toggleClass("active", mode === "all");
      $("#practice-btn").toggleClass("active", mode === "practice");
      order = [];
      visited = [];
      if (mode === "all") renderAllMode();
      else renderPracticeMode();
    }

    $(document).ready(function () {
      $.getJSON("Topics/Transformers/QA.json", function (data) {
        qaData = data;
        populateTopicTabs();
        setMode("all");
      }).fail(() => {
        $("#qa-container").html("<p>‚ùå Failed to load QA.json</p>");
      });

      $("#all-btn").on("click", () => setMode("all"));
      $("#practice-btn").on("click", () => setMode("practice"));
    });
  </script>
</body>
</html>

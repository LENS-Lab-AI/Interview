<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Q&A Practice</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  

  <!-- MathJax for LaTeX rendering -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

  <link rel="stylesheet" href="web_utils/style.css">

</head>

<body>
  <h1>Q&A Practice</h1>
  <br>
  <!-- Row 1: Mode buttons -->
  <div class="mode-switch">
    <button id="all-btn" class="active">üß† All Mode</button>
    <button id="practice-btn">‚ö° Practice Mode</button>
  </div>
  <br>
  <!-- Row 2: Topic Tabs -->
  <div class="topic-tabs" id="topic-tabs"></div>
  <br>
  <div id="qa-container"></div>

  <script>
    let qaData = [];
    let mode = "all";
    let currentTopic = "All";
    let currentIndex = -1;
    let order = [];
    let visited = [];

    function populateTopicTabs() {
      const topics = [...new Set(qaData.map(q => q.type).filter(Boolean))];
      const tabContainer = $("#topic-tabs");
      tabContainer.empty();

      // Always include "All"
      tabContainer.append(`<div class="topic-tab active" data-topic="All">All</div>`);
      topics.forEach(topic => {
        tabContainer.append(`<div class="topic-tab" data-topic="${topic}">${topic}</div>`);
      });

      $(".topic-tab").on("click", function () {
        $(".topic-tab").removeClass("active");
        $(this).addClass("active");
        currentTopic = $(this).data("topic");
        setMode(mode);
      });
    }

    function getFilteredData() {
      return currentTopic === "All" ? qaData : qaData.filter(q => q.type === currentTopic);
    }

    function renderAllMode() {
      const container = $("#qa-container");
      container.empty();
      const filtered = getFilteredData();

      filtered.forEach((q) => {
        const tagsHtml = q.tags && q.tags.length > 0 
          ? `<div class="tags-container">${q.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`
          : '';
        const card = $(`
          <div class="qa-card">
            <div class="type-tags-row">
              <div class="type-label">${q.type}</div>
              ${tagsHtml}
            </div>
            <div class="question">${q.id}. ${q.question}<span class="toggle-icon">+</span></div>
            <div class="answer">${q.answer}</div>
          </div>
        `);
        container.append(card);
      });

      $(".answer").hide();
      $(".toggle-icon").text("+");

      $(".question").on("click", function () {
        const ans = $(this).siblings(".answer");
        const icon = $(this).find(".toggle-icon");
        const isVisible = ans.is(":visible");
        ans.slideToggle(200);
        icon.text(isVisible ? "+" : "‚àí");
      });

      if (window.MathJax) MathJax.typesetPromise();
    }

    function renderPracticeMode(index = null) {
      const container = $("#qa-container");
      container.empty();
      const filteredData = getFilteredData();

      if (filteredData.length === 0) {
        container.html(`<p>‚ö†Ô∏è No questions in this topic.</p>`);
        return;
      }

      if (order.length === 0) {
        order = [...Array(filteredData.length).keys()];
        for (let i = order.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [order[i], order[j]] = [order[j], order[i]];
        }
        visited = [];
      }

      if (index !== null) currentIndex = index;
      else currentIndex = visited.length;

      if (currentIndex >= order.length) {
        container.html(`<p>üéâ You've completed all questions in this topic!</p>`);
        return;
      }

      const qIndex = order[currentIndex];
      visited.push(qIndex);
      const q = filteredData[qIndex];

      const tagsHtml = q.tags && q.tags.length > 0 
        ? `<div class="tags-container">${q.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`
        : '';
      const card = $(`
        <div class="practice-card">
          <div class="counter">Question ${currentIndex + 1} / ${filteredData.length}</div>
          <div class="type-tags-row">
            <div class="type-label">${q.type}</div>
            ${tagsHtml}
          </div>
          <div class="question">${q.id}. ${q.question}</div>
          <textarea class="user-input" id="user-answer" placeholder="Type your answer here..."></textarea>
          <div>
            <button id="check-btn">Check Answer</button>
            <button id="prev-btn">Previous</button>
            <button id="next-btn">Next</button>
          </div>
          <div id="correct-answer" class="answer-box">${q.answer}</div>
        </div>
      `);

      container.append(card);

      $("#check-btn").on("click", () => $("#correct-answer").slideDown(300));
      $("#next-btn").on("click", () => {
        if (currentIndex < order.length - 1) renderPracticeMode(currentIndex + 1);
        else container.html(`<p>üéâ You've completed all questions!</p>`);
      });
      $("#prev-btn").on("click", () => {
        if (currentIndex > 0) renderPracticeMode(currentIndex - 1);
      });

      if (window.MathJax) MathJax.typesetPromise();
    }

    function setMode(newMode) {
      mode = newMode;
      $("#all-btn").toggleClass("active", mode === "all");
      $("#practice-btn").toggleClass("active", mode === "practice");
      order = [];
      visited = [];
      if (mode === "all") renderAllMode();
      else renderPracticeMode();
    }

    $(document).ready(function () {
      $.getJSON("Topics/Transformers/QA.json", function (data) {
        qaData = data;
        populateTopicTabs();
        setMode("all");
      }).fail(() => {
        $("#qa-container").html("<p>‚ùå Failed to load QA.json</p>");
      });

      $("#all-btn").on("click", () => setMode("all"));
      $("#practice-btn").on("click", () => setMode("practice"));
    });
  </script>
</body>
</html>
